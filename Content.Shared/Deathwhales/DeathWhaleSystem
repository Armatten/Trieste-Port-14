using Content.Server.Event.Components;
using Robust.Shared.Prototypes;
using Content.Server.Deathwhale;

namespace Content.Shared.Deathwhale;

public sealed class DeathWhaleSystem : EntitySystem
{
    [Dependency] private readonly EntityLookupSystem _lookup = default!;

    private const float UpdateInterval = 1f;
    private float _updateTimer = 0f;

    public override void Initialize()
    {
        base.Initialize();
        // Subscribing to the initialization event for DeathWhaleComponent
        SubscribeLocalEvent<DeathWhaleComponent, ComponentInit>(OnCompInit);
    }

    public override void Update(float frameTime)
    {
        base.Update(frameTime);
        _updateTimer += frameTime;

        // Check if it's time to update based on the set interval
        if (_updateTimer >= UpdateInterval)
        {
            // Query all entities that have a DeathWhaleComponent
            foreach (var entity in EntityManager.EntityQuery<DeathWhaleComponent>())
            {
                var uid = entity.Owner;
                var component = EntityManager.GetComponent<DeathWhaleComponent>(uid); // Get the DeathWhaleComponent

                // Call the method to check for nearby entities
                DeathWhaleCheck(uid, component);
            }

            // Reset the timer
            _updateTimer = 0f;
        }
    }

    // Log message when the component is initialized
    private void OnCompInit(EntityUid uid, DeathWhaleComponent component, ComponentInit args)
    {
        Log.Info($"Deathwhale initialized for entity {uid}");
    }

    private void DeathWhaleCheck(EntityUid uid, DeathWhaleComponent component)
    {
        // Iterate through all entities within the DeathWhale's radius and check if they have a FallSystemComponent
        foreach (var prey in _lookup.GetEntitiesInRange(uid, component.Radius, LookupFlags.StaticSundries))
        {
            if (!EntityManager.HasComponent<FallSystemComponent>(prey))
            {
                // Skip entities that do not have a FallSystemComponent
                continue;
            }

            // Ensure the prey entity gets a FultonedComponent
            EnsureComp<FultonedComponent>(prey);
        }
    }
}
